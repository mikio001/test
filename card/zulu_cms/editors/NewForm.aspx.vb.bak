
Partial Class zulu_cms_editors_NewEditer
    Inherits System.Web.UI.Page

    Private Const UploadDirectory As String = "~/FileUpload/"
    Dim Editor = "NewEditor"
    Public Function GetSiteID() As String
        Dim SSiteID = rqSiteID()
        If SSiteID = "" Then SSiteID = Zulu.Cms.Factory.SiteID
        Return SSiteID
    End Function
    Protected Function rqSiteID() As String
        Return HttpContext.Current.Request.QueryString.Item("siteID")
    End Function
    Protected Function ContentID() As String
        Return Request.QueryString("ContentID")
    End Function
    Function UploadFile(ByVal FU As Object) As String
        If (Not FU.HasFile) Then
            Return ""
        End If
        If FU.FileName = "" Then Return ""
        Dim fileInfo As New IO.FileInfo(FU.FileName)

        Dim filename = Replace(fileInfo.Name, fileInfo.Extension, "") & "_" & Now.Ticks & fileInfo.Extension
        Dim resFileName As String = MapPath(UploadDirectory) & filename
        FU.SaveAs(resFileName)
        Return filename
    End Function
    Private Sub Save_Click()
        Dim newsID = Request.QueryString("itemID")
        Dim db = Zulu.Data.PlatformFactory.GetPlatform("ZuluDB", True, True)

        Dim filesavename = UploadFile(btnRefImg)
        Dim filesavename2 = UploadFile(btnRefUrl)
        Dim filesavename3 = UploadFile(btnRefImfGB)

        If String.IsNullOrEmpty(newsID) Then
            If Not Page.IsPostBack AndAlso Not Page.IsCallback Then
                If Not Zulu.Cms.Factory.CheckAddPermission(ContentID) Then Zulu.Web.Factory.GotoAppErrorPage("Access Denied!")
            End If



            db.Execute("insert into ZCMS_CONTENT(contentID,title,contentBody,createDate,createBy,modifyDate,modifyBy,siteID,editorID,contentType,status" & IIf(filesavename2 <> "", ",refUrl", "") & "" & IIf(filesavename <> "", ",imgUrl", "") & "" & IIf(filesavename3 <> "", ",imgUrl2", "") & ",subTitle) values(@contentID,@title,@html,GETDATE(),@username,GETDATE(),@username,@siteID,'NEWS',@contentType,0" & IIf(filesavename2 <> "", ",@refUrl", "") & "" & IIf(filesavename <> "", ",@imgUrl", "") & "" & IIf(filesavename3 <> "", ",@imgUrl2", "") & ",@subTitle)", db.NewParam("contentID", ContentID), db.NewParam("title", newsTitle.Text), db.NewParam("html", ASPxHtmlEditor1.Html), db.NewParam("username", Zulu.Security.Factory.UserProvider.GetCurrentUsername), db.NewParam("siteID", GetSiteID()), db.NewParam("contentType", cmbContentType.Value), db.NewParam("refUrl", filesavename2), db.NewParam("imgUrl", filesavename), db.NewParam("imgUrl2", filesavename3), db.NewParam("subTitle", newsSubTitle.Text))

         
            'btnRefImg.Text = ""
            'btnRefUrl.Text = ""
            'btnRefImg.Value = ""
            'btnRefUrl.Value = ""
        Else
            If Not Page.IsPostBack AndAlso Not Page.IsCallback Then
                If Not Zulu.Cms.Factory.CheckEditPermission(ContentID) Then Zulu.Web.Factory.GotoAppErrorPage("Access Denied!")
            End If

            db.Execute("update ZCMS_CONTENT set title=@title,contentBody=@html,createDate=GETDATE(),modifyDate=GETDATE(),modifyBy=@username,contentType=@contentType,status=0" & IIf(filesavename2 <> "", ",refUrl=@refUrl", "") & "" & IIf(filesavename <> "", ",imgUrl=@refImg", "") & "" & IIf(filesavename3 <> "", ",imgUrl2=@refImg2", "") & ",subTitle=@subTitle where itemID=@newsID", db.NewParam("title", newsTitle.Text), db.NewParam("html", ASPxHtmlEditor1.Html), db.NewParam("username", Zulu.Security.Factory.UserProvider.GetCurrentUsername), db.NewParam("newsID", newsID), db.NewParam("contentType", cmbContentType.Value), db.NewParam("refUrl", filesavename2), db.NewParam("subTitle", newsSubTitle.Text), db.NewParam("refImg", filesavename))
        End If

        Dim errMsg As String = ""

        If db.IsError(errMsg) Then
            ShowErrorMsg(errMsg)
        Else
            newsTitle.Text = ""
            ASPxHtmlEditor1.Html = ""
            newsSubTitle.Text = ""
            btnSave.Visible = False
            ShowSuccessMsg("บันทึกข้อมูลเรียบร้อยแล้ว")
        End If

        db.Close()
    End Sub

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not Page.IsCallback AndAlso Not Page.IsPostBack Then
            Dim newsID = Request.QueryString("itemID")

            If Not String.IsNullOrEmpty(newsID) Then
                Dim db = Zulu.Data.PlatformFactory.GetPlatform("ZuluDB", True, False)
                Dim dr = db.GetReader("select title,contentBody,expireDate,contentType,refUrl,imgUrl,subTitle,imgUrl2 from ZCMS_CONTENT where itemID=@itemID", db.NewParam("itemID", newsID))
                db.ThrowIfError()

                If dr.Read Then
                    newsTitle.Text = dr.GetString(0)
                    'newsExpireDate.Date = dr.GetDateTime(2)
                    If Not dr.IsDBNull(6) Then newsSubTitle.Text = dr.GetString(6)

                    If Not dr.IsDBNull(4) Then
                        '    btnRefUrl.Value = dr.GetString(4)
                        lblRefUrl.Text = "<a target='_blank' href='" & ResolveClientUrl(UploadDirectory & dr.GetString(4)) & "'>" & dr.GetString(4) & "<a>"
                    End If

                    If Not dr.IsDBNull(5) Then
                        '    btnRefImg.Value = dr.GetString(5)
                        lblRefImg.Text = "<a target='_blank' href='" & ResolveClientUrl(UploadDirectory & dr.GetString(5)) & "'>" & dr.GetString(5) & "<a>"
                    End If

                    If Not dr.IsDBNull(7) Then
                        lblRefImfGB.Text = "<a target='_blank' href='" & ResolveClientUrl(UploadDirectory & dr.GetString(7)) & "'>" & dr.GetString(7) & "<a>"
                    End If
                    ASPxHtmlEditor1.Html = dr.GetString(1)
                    cmbContentType.DataBind()
                    SqlDataSource1.DataBind()
                    If Not dr.IsDBNull(3) Then cmbContentType.Value = dr.GetInt32(3)
                End If

                dr.Close()
                db.Close()
            End If
        End If

       
        With btnCancel
            Dim PageForm = HttpContext.Current.Request.QueryString.Item("FormSelect")
            If PageForm = "" Then
                .ClientSideEvents.Click = ("function(s,e){window.location='" & Me.ResolveClientUrl(("~/zulu_cms/editors/" & Editor & ".aspx?contentID=" & Me.ContentID)) & "&SiteID=" & GetSiteID() & "';}")
            Else
                .ClientSideEvents.Click = ("function(s,e){window.location='" & Me.ResolveClientUrl("~/" & PageForm) & ".aspx';}")
            End If
            '.ClientSideEvents.Click = GetShowEditorClientHandler("NewsEditor")
        End With
    End Sub

    Public Sub ShowErrorMsg(ByVal errMsg As String)
        ltMsg.Text = "<img src=""" & ResolveClientUrl("~/zulu_web/images/error.gif") & """ align=""absmiddle"" />ERROR:" & errMsg
    End Sub

    Public Sub ShowSuccessMsg(ByVal errMsg As String)
        ltMsg.Text = "<img src=""" & ResolveClientUrl("~/zulu_web/images/ok.gif") & """ align=""absmiddle"" />" & errMsg
    End Sub

    Protected Sub cbPanel_Callback(sender As Object, e As DevExpress.Web.ASPxClasses.CallbackEventArgsBase) Handles cbPanel.Callback
        If e.Parameter = "SAVE" Then
            Save_Click()
        End If
    End Sub

    Protected Sub btnSave_Click(sender As Object, e As EventArgs) Handles btnSave.Click
        Save_Click()
    End Sub
End Class
